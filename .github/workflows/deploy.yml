name: Terraform CI/CD

on:
    push:
        branches:
            - main

jobs:
    deploy:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3

            - name: Set up AWS creds
              uses: aws-actions/configure-aws-credentials@v2
              with:
                aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                aws-region: eu-west-3

            - name: Setup Terraform
              uses: hashicorp/setup-terraform@v3
              with:
                terraform_version: "1.1.7"

            - name: Select environment
              run: |
                if [[ $GITHUB_REF_NAME == "dev" ]]; then
                    BACKEND_FILE=backend-dev.hcl
                elif [[ $GITHUB_REF_NAME = "staging" ]]; then
                    BACKEND_FILE=backend-staging.hcl
                else
                    BACKEND_FILE=backend-prod.hcl
                fi
                echo "Using backend $BACKEND_FILE"
                echo "BACKEND_FILE=$BACKEND_FILE" >> $GITHUB_ENV

            - name: Terraform init
              run: terraform init -backend-config=$BACKEND_FILE

            - name: Terraform plan
              run: terraform plan

            - name: Terraform apply
              run: terraform apply -auto-approve